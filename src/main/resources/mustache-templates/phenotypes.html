{{>layout/header}}

<div class="container vertical-space">
	<h3>Patient Info</h3>
	<ul class="list-unstyled">
		{{#patient}}
		<li>Name: <span>{{firstName}} {{lastName}}</span></li>
		<li>Id: <span id="patient_id">{{id}}</span></li>
		{{/patient}}
	</ul>
	<h3>Phenotypes</h3>
	<table id="hposummary" class="table  table-striped table-bordered" style="width:100%">
		<thead>
			<tr>
				<th></th>
				<th>HPO Term Name</th>
				<th>HPO Term Id</th>
				<th># Observations</th>
				<th>First Date</th>
				<th>Last Date</th>
			</tr>
		</thead>
	</table>
</div>

<script type="text/javascript"
	src="https://code.jquery.com/jquery-3.3.1.js"></script>
<script type="text/javascript"
	src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script type="text/javascript"
	src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>
<script type="text/javascript">
	function format ( d ) {
		console.log(d);
	    // `d` is the original data object for the row
	    let table = "<table><thead><tr><th>FHIR Id</th><th>LOINC</th><th>Description</th><th>Date</th></thead><tbody>";
	    for (i = 0; i < d.observations.length; i++) {
	    	let observation = d.observations[i];
	    	table += "<tr><td>" + observation.fhirId + "</td><td>" + observation.loincId + "</td><td>" +
	    		observation.description + "</td><td>" + observation.date + "</td></tr>";
	    }
	    table += "</tbody></table>";
	    return table;
	}
	
	let patientId = $("#patient_id").html();
	
	$(document).ready(function() {
		// Set up table sorting
	    let table = $("#hposummary").DataTable({
	    	ajax: {
	    	    "url": "/summary/" + patientId
	    	},
	    	paging: true,
	       	searching: false,
	       	columns: [
	            {
	                "className":      'details-control',
	                "orderable":      false,
	                "data":           null,
	                "defaultContent": ''
	            },
	            { "data": "hpoTermName" },
	            { "data": "hpoTermId" },
	            { "data": "count" },
	            { "data": "first" },
	            { "data": "last" }
	       		
	       	],
	    	aaSorting: [] // Do not sort any columns initially
    	});
		
		// Add event listener for opening and closing details
	    $('#hposummary tbody').on('click', 'td.details-control', function () {
	        let tr = $(this).closest('tr');
	        let row = table.row( tr );
	 
	        if ( row.child.isShown() ) {
	            // This row is already open - close it
	            row.child.hide();
	            tr.removeClass('shown');
	        }
	        else {
	            // Open this row
	            row.child( format(row.data()) ).show();
	            tr.addClass('shown');
	        }
	    } );

	});
	
</script>

{{>layout/footer}}
